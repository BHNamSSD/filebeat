-------------------------------------------------------------------
| TÃ¡ch filebeat ra thÃ nh nhiá»u service hoáº¡t Ä‘á»™ng
-------------------------------------------------------------------


-------------------------------------------------------------------
ğŸ§© Má»¥c tiÃªu
-------------------------------------------------------------------
Táº¡o 2 service:
filebeat-fail2ban.service â†’ Ä‘á»c /var/log/fail2ban.log
filebeat-auth.service â†’ Ä‘á»c /var/log/auth.log


-------------------------------------------------------------------
âš™ï¸ BÆ°á»›c 1: Táº¡o 2 file cáº¥u hÃ¬nh riÃªng
-------------------------------------------------------------------
/etc/filebeat/filebeat-fail2ban.yml
filebeat.inputs:
  - type: log
    enabled: true
    paths:
      - /var/log/fail2ban.log
    fields:
      log_type: fail2ban
    fields_under_root: true

output.logstash:
  hosts: ["elk-server:5045"]

/etc/filebeat/filebeat-auth.yml
filebeat.inputs:
  - type: log
    enabled: true
    paths:
      - /var/log/auth.log
    fields:
      log_type: auth
    fields_under_root: true

output.logstash:
  hosts: ["elk-server:5046"]


-------------------------------------------------------------------
âš™ï¸ BÆ°á»›c 2: NhÃ¢n Ä‘Ã´i service gá»‘c
-------------------------------------------------------------------
sudo cp /lib/systemd/system/filebeat.service /etc/systemd/system/filebeat-fail2ban.service
sudo cp /lib/systemd/system/filebeat.service /etc/systemd/system/filebeat-auth.service

-------------------------------------------------------------------
âš™ï¸ BÆ°á»›c 3: Sá»­a ná»™i dung tá»«ng file service
-------------------------------------------------------------------
/etc/systemd/system/filebeat-fail2ban.service

thay dÃ²ng:
Environment="BEAT_CONFIG_OPTS=-c /etc/filebeat/filebeat.yml"

thÃ nh: 
Environment="BEAT_CONFIG_OPTS=-c /etc/filebeat/filebeat-fail2ban.yml"

Äá»“ng thá»i Ä‘á»•i tÃªn mÃ´ táº£ Ä‘á»ƒ dá»… phÃ¢n biá»‡t:
Description=Filebeat Fail2ban - sends /var/log/fail2ban.log to Logstash

TÃ¬m dÃ²ng:
Environment="BEAT_PATH_OPTS=--path.home /usr/share/filebeat --path.config /etc/filebeat --path.data /var/lib/filebeat --path.logs /var/log/filebeat"

Sá»­a thÃ nh (thÃªm thÆ° má»¥c riÃªng, vÃ­ dá»¥ /var/lib/filebeat-fail2ban):
Environment="BEAT_PATH_OPTS=--path.home /usr/share/filebeat --path.config /etc/filebeat --path.data /var/lib/filebeat-fail2ban --path.logs /var/log/filebeat"

Táº¡o thÆ° má»¥c Ä‘Ã³ vÃ  gÃ¡n quyá»n:
sudo mkdir -p /var/lib/filebeat-fail2ban
sudo chown root:root /var/lib/filebeat-fail2ban
sudo chmod 750 /var/lib/filebeat-fail2ban


-------------------------------------------------------------------
âš™ï¸ BÆ°á»›c 4: Reload vÃ  kÃ­ch hoáº¡t
-------------------------------------------------------------------
sudo systemctl daemon-reload
sudo systemctl enable --now filebeat-fail2ban
sudo systemctl enable --now filebeat-auth

-------------------------------------------------------------------
âœ… BÆ°á»›c 5: Kiá»ƒm tra tráº¡ng thÃ¡i
-------------------------------------------------------------------
sudo systemctl status filebeat-fail2ban
sudo systemctl status filebeat-auth


-------------------------------------------------------------------
báº£n chuáº©n Ã¡p dá»¥ng khi cÃ³ nhiá»u service Filebeat song song ğŸ‘‡
-------------------------------------------------------------------

-------------------------------------------------------------------
ğŸ§° 1. Cháº¡y Filebeat á»Ÿ foreground (debug) â€” riÃªng tá»«ng instance
-------------------------------------------------------------------
sudo /usr/share/filebeat/bin/filebeat -e -c /etc/filebeat/filebeat-fail2ban.yml --path.data /var/lib/filebeat-fail2ban
âš ï¸ Quan trá»ng: thÃªm --path.data /var/lib/filebeat-fail2ban Ä‘á»ƒ trÃ¡nh bá»‹ lock.


-------------------------------------------------------------------
ğŸ§© 2. Kiá»ƒm tra cáº¥u hÃ¬nh trÆ°á»›c khi start
-------------------------------------------------------------------
sudo filebeat test config -c /etc/filebeat/filebeat-fail2ban.yml
sudo filebeat test config -c /etc/filebeat/filebeat-auth.yml

âœ… Náº¿u bÃ¡o Config OK lÃ  an toÃ n Ä‘á»ƒ start service.

-------------------------------------------------------------------
3. Kiá»ƒm tra káº¿t ná»‘i tá»›i Logstash
-------------------------------------------------------------------
sudo filebeat test output -c /etc/filebeat/filebeat-fail2ban.yml



-------------------------------------------------------------------
ğŸ§ª 4. Test cháº¡y vá»›i file config riÃªng (khÃ´ng áº£nh hÆ°á»Ÿng service)
-------------------------------------------------------------------
Náº¿u báº¡n muá»‘n kiá»ƒm tra táº¡m thá»i má»™t config khÃ¡c, vÃ­ dá»¥ filebeat-test.yml:
sudo filebeat -e -c /etc/filebeat/filebeat-test.yml --path.data /var/lib/filebeat-test

-------------------------------------------------------------------
â™»ï¸ 5. Äá»c láº¡i log tá»« Ä‘áº§u (xÃ³a registry)
-------------------------------------------------------------------
sudo systemctl stop filebeat-fail2ban
sudo rm -rf /var/lib/filebeat-fail2ban/registry
sudo filebeat -e -c /etc/filebeat/filebeat-fail2ban.yml --path.data /var/lib/filebeat-fail2ban

















